<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Колесо фортуны</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #111;
      color: #fff;
    }
    canvas {
      border-radius: 50%;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      margin-bottom: 10px;
    }
    .controls {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    input {
      padding: 8px;
      font-size: 16px;
      border-radius: 8px;
      border: none;
      outline: none;
      text-align: center;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 12px;
      background: #3498db;
      color: white;
      cursor: pointer;
    }
    button:disabled {
      opacity: .5;
      cursor: not-allowed;
    }
    .hint { opacity:.85; font-size: 14px; margin-top: 6px; }
  </style>
</head>
<body>
  <canvas id="wheel" width="400" height="400" aria-label="Колесо"></canvas>
  <div id="result"></div>

  <div class="controls">
    <input id="promoCode" type="text" placeholder="Введите промокод" />
    <button id="spin">Крутить</button>
    <div class="hint">Промокод можно использовать один раз на аккаунт Telegram</div>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
  const tg = window.Telegram.WebApp;
  tg.expand();

  const canvas = document.getElementById('wheel');
  const ctx = canvas.getContext('2d');
  const result = document.getElementById('result');
  const btn = document.getElementById('spin');
  const promoInput = document.getElementById('promoCode');

  // ------- цвета и сектора -------
  const colors = ['#e74c3c','#3498db','#f1c40f','#2ecc71','#9b59b6','#e67e22','#1abc9c','#ff6b81','#ffa502','#3742fa'];
  const sectors = ['1500 руб','1000 руб','700 руб','500 руб','х2 к выигрышу','х3 к выигрышу','именной винил + подписка'];

  let spinning = false;

  // ------- CloudStorage helpers (fallback на localStorage) -------
  const CS = tg.CloudStorage;
  function csGet(key) {
    return new Promise((resolve) => {
      if (!CS || !CS.getItem) return resolve(localStorage.getItem(key));
      CS.getItem(key, (err, value) => { resolve(err ? null : value); });
    });
  }
  function csSet(key, value) {
    return new Promise((resolve) => {
      if (!CS || !CS.setItem) {
        localStorage.setItem(key, value);
        return resolve(true);
      }
      CS.setItem(key, value, (err) => { resolve(!err); });
    });
  }

  // ------- Отрисовка колеса -------
  function wrapText(context, text, x, y, maxWidth, lineHeight) {
    const words = text.split(' ');
    let line = '';
    const lines = [];
    for (let n = 0; n < words.length; n++) {
      const test = line + words[n] + ' ';
      if (context.measureText(test).width > maxWidth && n > 0) {
        lines.push(line);
        line = words[n] + ' ';
      } else {
        line = test;
      }
    }
    lines.push(line);
    for (let i = 0; i < lines.length; i++) {
      context.fillText(lines[i], x, y + i * lineHeight);
    }
  }

  function drawWheel(angle = 0) {
    const radius = canvas.width / 2;
    const arc = (2 * Math.PI) / sectors.length;
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    for (let i = 0; i < sectors.length; i++) {
      const start = i * arc + angle;
      const g = ctx.createRadialGradient(radius, radius, 24, radius, radius, radius);
      g.addColorStop(0, '#fff');
      g.addColorStop(1, colors[i % colors.length]);
      ctx.fillStyle = g;
      ctx.beginPath();
      ctx.moveTo(radius, radius);
      ctx.arc(radius, radius, radius, start, start + arc);
      ctx.lineTo(radius, radius);
      ctx.fill();
      ctx.strokeStyle = '#222';
      ctx.stroke();

      ctx.save();
      ctx.translate(radius, radius);
      ctx.rotate(start + arc / 2);
      ctx.textAlign = 'right';
      ctx.fillStyle = '#fff';
      ctx.font = 'bold 16px system-ui';
      ctx.shadowColor = 'black';
      ctx.shadowBlur = 4;
      wrapText(ctx, sectors[i], radius - 16, -10, 100, 18);
      ctx.restore();
    }
    ctx.beginPath();
    ctx.fillStyle = '#222';
    ctx.arc(radius, radius, 22, 0, Math.PI * 2);
    ctx.fill();
  }

  // ------- Вращение/завершение -------
  function rotateWheel() {
    if (spinning) return;
    spinning = true;
    btn.disabled = true;

    const arc = (2 * Math.PI) / sectors.length;
    const spinAngle = Math.random() * sectors.length * arc + 10 * Math.PI; // минимум ~5 оборотов
    let current = 0;
    const duration = 5000;
    const start = performance.now();

    function animate(now) {
      const t = Math.min((now - start) / duration, 1);
      // плавное замедление
      current = spinAngle * (t) * (1 - Math.pow(t, 3));
      drawWheel(current);
      if (t < 1) requestAnimationFrame(animate);
      else {
        current = spinAngle;
        drawWheel(current);
        finish(current);
      }
    }
    requestAnimationFrame(animate);
  }

  function finish(angle) {
    const arc = (2 * Math.PI) / sectors.length;
    const idx = Math.floor((sectors.length - (angle % (2 * Math.PI)) / arc) % sectors.length);
    const prize = sectors[idx];
    result.innerText = "Выпало: " + prize;
    sendResultToBot(prize).finally(() => {
      // помечаем промокод использованным в облачном хранилище
      const code = promoInput.value.trim().toUpperCase();
      if (code) csSet(`used:${code}`, '1');
      spinning = false;
      btn.disabled = false;
    });
  }

  // ------- Связь с ботом -------
  async function checkPromoAndSpin() {
    const code = promoInput.value.trim().toUpperCase();

    if (!code) {
      alert("Введите промокод!");
      return;
    }
    const user = tg.initDataUnsafe && tg.initDataUnsafe.user;
    if (!user || !user.id) {
      alert("❌ Открой колесо внутри Telegram!");
      return;
    }

    // Клиентская защита: блокируем повтор по CloudStorage (переживёт перезагрузку)
    const already = await csGet(`used:${code}`);
    if (already === '1') {
      tg.showAlert("Этот промокод уже использован на вашем аккаунте.");
      return;
    }

    rotateWheel(); // запускаем анимацию
  }

  function sendResultToBot(prize) {
    return new Promise((resolve) => {
      const user = tg.initDataUnsafe.user;
      const payload = {
        prize,
        user_id: user.id,
        username: user.username || "",
        first_name: user.first_name || "Игрок",
        promo_code: promoInput.value.trim().toUpperCase()
      };
      try {
        tg.sendData(JSON.stringify(payload));
      } catch (e) {
        console.error("sendData error:", e);
      }
      resolve();
    });
  }

  // ------- init -------
  drawWheel();
  btn.addEventListener('click', checkPromoAndSpin);
  </script>
</body>
</html>
