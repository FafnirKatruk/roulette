<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Колесо фортуны</title>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #111;
      color: white;
    }
    canvas {
      border-radius: 50%;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      margin-bottom: 10px;
    }
    .controls {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    input {
      padding: 8px;
      font-size: 16px;
      border-radius: 8px;
      border: none;
      outline: none;
      text-align: center;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 12px;
      background: #3498db;
      color: white;
      cursor: pointer;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <canvas id="wheel" width="400" height="400"></canvas>
  <div id="result"></div>

  <div class="controls">
    <input id="promoCode" type="text" placeholder="Введите промокод">
    <button id="spin">Крутить</button>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
  const tg = window.Telegram.WebApp;
  tg.expand();

  const canvas = document.getElementById('wheel');
  const ctx = canvas.getContext('2d');
  const result = document.getElementById('result');
  const btn = document.getElementById('spin');
  const promoInput = document.getElementById('promoCode');

  const colors = ['#e74c3c','#3498db','#f1c40f','#2ecc71','#9b59b6','#e67e22','#1abc9c','#ff6b81','#ffa502','#3742fa'];

  const wheels = {
    purple: ['1500 руб','1000 руб','700 руб','500 руб','х2 к выигрышу','х3 к выигрышу','именной винил + подписка'],
    blue: ['1000 руб','500 руб','300 руб','х2 к выигрышу','х3 к выигрышу']
  };

  let sectors = [...wheels.purple];
  let spinning = false;

  // ======= рисование =======
  function wrapText(context, text, x, y, maxWidth, lineHeight) {
    const words = text.split(' ');
    let line = '';
    const lines = [];
    for (let n = 0; n < words.length; n++) {
      const testLine = line + words[n] + ' ';
      const metrics = context.measureText(testLine);
      if (metrics.width > maxWidth && n > 0) {
        lines.push(line);
        line = words[n] + ' ';
      } else {
        line = testLine;
      }
    }
    lines.push(line);
    for (let i = 0; i < lines.length; i++) {
      context.fillText(lines[i], x, y + (i * lineHeight));
    }
  }

  function drawWheel(angle=0) {
    const radius = canvas.width / 2;
    const arc = (2 * Math.PI) / sectors.length;
    ctx.clearRect(0,0,canvas.width,canvas.height);

    for (let i = 0; i < sectors.length; i++) {
      const start = i * arc + angle;
      const g = ctx.createRadialGradient(radius, radius, 24, radius, radius, radius);
      g.addColorStop(0, '#fff');
      g.addColorStop(1, colors[i % colors.length]);
      ctx.fillStyle = g;
      ctx.beginPath();
      ctx.moveTo(radius, radius);
      ctx.arc(radius, radius, radius, start, start + arc);
      ctx.lineTo(radius, radius);
      ctx.fill();
      ctx.strokeStyle = '#222';
      ctx.stroke();
      ctx.save();
      ctx.translate(radius, radius);
      ctx.rotate(start + arc/2);
      ctx.textAlign = 'right';
      ctx.fillStyle = '#fff';
      ctx.font = 'bold 16px system-ui';
      ctx.shadowColor = 'black';
      ctx.shadowBlur = 4;
      wrapText(ctx, sectors[i], radius-16, -10, 100, 18);
      ctx.restore();
    }
    ctx.beginPath();
    ctx.fillStyle = '#222';
    ctx.arc(radius, radius, 22, 0, Math.PI*2);
    ctx.fill();
  }

  // ======= вращение =======
  function rotateWheel() {
    if (spinning) return;
    spinning = true;
    btn.disabled = true;

    const arc = (2 * Math.PI) / sectors.length;
    const spinAngle = Math.random() * sectors.length * arc + 10 * Math.PI; // минимум 5 оборотов
    let current = 0;
    const duration = 5000;
    const start = performance.now();

    function animate(now) {
      const elapsed = now - start;
      if (elapsed < duration) {
        current = spinAngle * (elapsed/duration) * (1 - Math.pow(elapsed/duration, 3));
        drawWheel(current);
        requestAnimationFrame(animate);
      } else {
        current = spinAngle;
        drawWheel(current);
        finish(current);
      }
    }
    requestAnimationFrame(animate);
  }

  function finish(angle) {
    const arc = (2 * Math.PI) / sectors.length;
    const index = Math.floor((sectors.length - (angle % (2*Math.PI)) / arc) % sectors.length);
    const prize = sectors[index];
    result.innerText = "Выпало: " + prize;
    sendResultToBot(prize);
    spinning = false;
  }

  // ======= связь с ботом =======
  function checkPromoAndSpin() {
    const code = promoInput.value.trim().toUpperCase();
    if (!code) {
      alert("Введите промокод!");
      return;
    }

    if (!tg.initDataUnsafe || !tg.initDataUnsafe.user) {
      alert("❌ Открой колесо внутри Telegram!");
      return;
    }

    // отправляем запрос проверки промо
    tg.sendData(JSON.stringify({ check_promo: code }));

    // ⚠️ дальше крутить только если бот подтвердил
    // пока имитация: даём крутить через 1с
    setTimeout(() => {
      rotateWheel();
    }, 1000);
  }

  function sendResultToBot(prize) {
    const user = tg.initDataUnsafe.user;
    const data = {
      prize: prize,
      user_id: user.id,
      username: user.username || "",
      first_name: user.first_name || "Игрок",
      promo_code: promoInput.value.trim().toUpperCase()
    };
    tg.sendData(JSON.stringify(data));
  }

  // ======= init =======
  drawWheel();
  btn.addEventListener('click', checkPromoAndSpin);
  </script>
</body>
</html>
